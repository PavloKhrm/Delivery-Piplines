- hosts: all
  vars:
    KUBECONFIG_LOCAL: kubeconfig_{{ inventory_hostname }}.yaml
  tasks:
    - name: Add Helm repos
      local_action: shell |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo add opensearch https://opensearch-project.github.io/helm-charts/
        helm repo update

    - name: Ensure namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ KUBECONFIG_LOCAL }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ client_namespace }}"

    - name: Deploy client stack
      local_action: shell |
        helm upgrade --install {{ client_namespace }} ./charts/client-stack \
        --kubeconfig {{ KUBECONFIG_LOCAL }} \
        --namespace {{ client_namespace }} \
        --set global.domain={{ client_domain }} \
        --set global.clientName={{ client_namespace }} \
        --set ingress.enabled=true \
        --set ingress.hosts[0].host={{ client_domain }} \
        --set ingress.hosts[0].paths[0].path=/ \
        --set ingress.hosts[0].paths[0].pathType=Prefix \
        --set ingress.tls[0].hosts[0]={{ client_domain }} \
        --set ingress.tls[0].secretName={{ client_namespace }}-tls \
        --set backend.image.tag={{ lookup('env','BACKEND_TAG') | default('latest', true) }} \
        --set frontend.image.tag={{ lookup('env','FRONTEND_TAG') | default('latest', true) }} \
        --atomic --wait
