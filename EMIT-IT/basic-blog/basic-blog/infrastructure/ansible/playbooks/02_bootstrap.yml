- hosts: all
  vars:
    KUBECONFIG_LOCAL: kubeconfig_{{ inventory_hostname }}.yaml

  tasks:
    # -------------------------------
    # Helm repos
    # -------------------------------
    - name: Add required Helm repos
      local_action: shell |
        helm repo add traefik https://traefik.github.io/charts
        helm repo add jetstack https://charts.jetstack.io
        helm repo add hcloud https://charts.hetzner.cloud
        helm repo update

    # -------------------------------
    # Traefik Ingress Controller
    # -------------------------------
    - name: Install Traefik via Helm
      local_action: shell |
        helm upgrade --install traefik traefik/traefik \
        --kubeconfig {{ KUBECONFIG_LOCAL }} \
        -n kube-system --create-namespace \
        --set ports.web.redirectTo=websecure \
        --set ports.websecure.tls.enabled=true

    # -------------------------------
    # cert-manager
    # -------------------------------
    - name: Install cert-manager CRDs
      local_action: shell |
        kubectl --kubeconfig {{ KUBECONFIG_LOCAL }} \
        apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.crds.yaml

    - name: Install cert-manager via Helm
      local_action: shell |
        helm upgrade --install cert-manager jetstack/cert-manager \
        --kubeconfig {{ KUBECONFIG_LOCAL }} \
        -n cert-manager --create-namespace \
        --version v1.14.4 \
        --set installCRDs=false

    - name: Create ClusterIssuer (Letâ€™s Encrypt)
      kubernetes.core.k8s:
        kubeconfig: "{{ KUBECONFIG_LOCAL }}"
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              email: "{{ email_lets_encrypt }}"
              server: https://acme-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-prod
              solvers:
                - http01:
                    ingress:
                      class: traefik

    # -------------------------------
    # Hetzner CSI (storage driver)
    # -------------------------------
    - name: Install Hetzner CSI
      local_action: shell |
        helm upgrade --install hcloud-csi hcloud/hcloud-csi \
        --kubeconfig {{ KUBECONFIG_LOCAL }} \
        -n kube-system --create-namespace \
        --set secret.token={{ lookup('env', 'HCLOUD_TOKEN') }}

    # -------------------------------
    # Client Namespace
    # -------------------------------
    - name: Ensure client namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ KUBECONFIG_LOCAL }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ client_namespace }}"
